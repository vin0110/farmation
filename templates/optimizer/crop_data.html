{% extends "base.html" %}
{% load humanize %}
{% load static %}


{% block head_title %}Crop Data{% endblock %}
{% block extra_head %} 

  <!--  Downloads loader script for Google Charts. -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript" src="{% static "js/chartUtils.js" %}"></script>
  <style>
    div.chart_div {
      display: inline-block;
    }
  </style>

{% endblock %}
{% block body %}


<div class="container">
  <div class="row">
    <div class="col">
      <h3 style="text-align: center">
      Crop Data : <b style="text-transform: uppercase"><font color="blue">{{ cropdata.name }}</font></b>
      </h3>
    </div>
  </div>

  <div class="row">
    <div class="col"> 
      <b>Cost per acre</b>: ${{ cropdata.cost|floatformat:2|intcomma }}
    </div>
  </div>

</div>

<div class="container" style="text-align:center">
  <div class="row">
    <div class="col">
      <hr style="color:blue">
      <h4>Price Distribution</h3>
    </div>

    <div class="col">
      <hr style="color:blue">
      <h4>Yield Distribution</h4>
    </div>

  </div>

  <div class="row">
    <div class="col">
      <div id="priceChart" class="chart_div"></div>
    </div>

    <div class="col">
      <div id="yieldChart" class="chart_div"></div>
    </div>
  </div>
</div>

<script> 
  // Loads Google Charts packages, then calls chartSetup()
  google.charts.load('current', {'packages': ['corechart', 'controls']});
  google.charts.setOnLoadCallback( chartSetup )

  // Global for storing options for each chart type.
  var options = []

  // Global settings for triangle plots for prices.
  options[ 'price_triangle' ] = {
    hAxis: {
      format: 'currency',
      title: 'Price (dollar / {{cropdata.unit}})'
    },
    vAxis: {
      textPosition: 'none',
      gridlines: {
        count: 0
      }
    },
    legend: {
      position: 'none'
    }
  }

  // Global settings for triangle plots for yields.
  options[ 'yield_triangle' ] =  {
    hAxis: {
      title: 'Yield ({{cropdata.unit}} / acre)'
    },
    vAxis: {
      textPosition: 'none',
      gridlines: {
        count: 0
      }
    },
    legend: {
      position: 'none'
    }
  }

  /**
   * Attempts to load stats for crop prices. If loading is unsuccesful, 
   * an error is thrown. Should crop data ever need to be dynamic, 
   * replace this with an AJAX call.
   */
  async function loadCropPrices() {
    const priceStatsJSON =  '{{ cropdata.prices|escapejs }}'

    if ( priceStatsJSON != '' ) {
      return {
        'values': JSON.parse( priceStatsJSON )
      }
    } else {
      throw "Error in loadCropPrices()!"
    }
  }

  /**
   * Attempts to stats for crop yields. If loading is successful, the array
   * is converted to an array of arrays (formatting for Google Charts') and returned.
   * If loading is unsuccesful, an error is thrown.
   *
   * If crop data ever needs to be dynamic, replace this with an AJAX call.
   */
  async function loadCropYields() {
    const yieldStatsJSON = '{{ cropdata.yields|escapejs }}'

    if ( yieldStatsJSON != '') {
      return {
        'values': JSON.parse( yieldStatsJSON )
      }
    } else {
      throw "Error in loadCropYields()!"
    }
  }

  /**
   * Loads data needed for charts into ChartWrappers, 
   * configures the charts, then plots the data. 
   */
  async function chartSetup() {
    var priceChart = new google.visualization.ChartWrapper({
      containerId: 'priceChart'
    });

    var yieldChart = new google.visualization.ChartWrapper({
      containerId: 'yieldChart'
    });

    // Attempts to load yield and price data.
    try {
      [ prices, yields ] = await Promise.all( [ loadCropPrices(), loadCropYields() ] );
    } catch ( error ) {
      console.log( error )
    }

    var priceFormatter = new Intl.NumberFormat( 'en-US', {
      style: 'currency',
      currency: 'USD',
    })

    var yieldFormatter = new Intl.NumberFormat( 'en-US', {
      style: 'decimal',
    })


    // Configures and draws triangle distributions.
    setupTriangle( prices, options[ 'price_triangle' ], priceFormatter ).
      then( priceTable => drawChart( priceChart, 'AreaChart', priceTable, options[ 'price_triangle' ]))

    setupTriangle( yields, options[ 'yield_triangle' ], yieldFormatter ).
      then( yieldTable => drawChart( yieldChart, 'AreaChart', yieldTable, options[ 'yield_triangle' ]))
  }

</script>

{% endblock %}
