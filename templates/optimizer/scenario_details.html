{% extends "base.html" %}
{% load humanize %}
{% load static %}

{% block head_title %}Scenario|Details{% endblock %}

{% block extra_head %}
  <!-- Loads Google Charts library. -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript" src="{% static "js/chartUtils.js" %}"></script>
{% endblock %}

{% block body %}
<div class="container">
  <div class="row">
    <div class="col">
      <h3>
        Scenario details
      </h3>
      <p>
        Farm:
        <a href="{% url "farm:farm" scenario.farm.id %}">
          {{ scenario.farm.name }}
        </a>
        &nbsp;&nbsp;&nbsp;&nbsp;
        <a href="{% url "optimizer:list" scenario.farm.id %}">
          all scenarios
        </a>
      </p>
      <p>
        Scenario: {{ scenario }}
        &nbsp;
        <a data-toggle="modal" href="#editName">
          <i class="fas fa-edit"></i>
        </a>
        <!-- Modal -->
        <div class="modal fade" id="editName" tabindex="-1" role="dialog" aria-labelledby="videoTitleLabel" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <form class="well" method="post">
                <div class="modal-header">
                  <h5 class="modal-title" id="editName">
                    Edit Scenario Name
                  </h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  {% csrf_token %}
                  {{ form.as_p }}
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
              </form>
            </div>
          </div>
        </div>   {# end modal #}
      </p>
      <hr/>
    </div>
  </div>
</div>

{% comment %}<div class="container">
  <div class="row">
    <div id="cropPartitionsChart" class="col">
    </div>
  </div>
</div>

<div class="container">
    <div class="row">
      <div class="col">
        <button class="btn btn-primary" onclick="drawCharts()">
          Update 
        </button>
    </div>
  </div>
</div>
{% endcomment %}

<div class="container">

  <div class="row">
    <div class="col" >
      <div id="scenarioChart"></div>
    </div>
  </div>
  <div class="row">
    <div class="col-sm">
    </div>
    <div class="col-md-6">
      <b>Profit profile</b>
    </div>
    <div class="col-sm">
      <b>Partition</b>
    </div>
  </div>
  <div class="row">
    <div class="col-sm">
      Best worst case
    </div>
    <div class="col-md-6">
      {{ scenario.min }}
    </div>
    <div class="col-sm">
      {{ scenario.min_partition }}
    </div>
  </div>
  <div class="row">
    <div class="col-sm">
      Best expected
    </div>
    <div class="col-md-6">
      {{ scenario.peak }}
    </div>
    <div class="col-sm">
      {{ scenario.peak_partition }}
    </div>
  </div>
  <div class="row">
    <div class="col-sm">
      Best best case
    </div>
    <div class="col-md-6">
      {{ scenario.max }}
    </div>
    <div class="col-sm">
      {{ scenario.max_partition }}
    </div>
  </div>
  <div class="row">
    <br/>
  </div>
  <div class="row">
    <a href="{% url "optimizer:updateScenario" scenario.id %}" class="btn btn-primary btn-lg active" role="button" aria-pressed="true">Update</a>
  </div>
</div>

<div class="container">
    <div class="row">
      <div class="col">
        <hr/>
        <h3>Crops</h3>
    </div>
  </div>
  <div class="row">
    <div class="col-sm">
      <b>Crop</b>
    </div>
    <div class="col-md-2" align="right">
      <b>Gross</b> (per acre)
    </div>
    <div class="col-md-2" align="right">
      <b>Price</b> (per acre)
    </div>
    <div class="col-md-2" align="right">
      <b>Yield</b> (per acre)
    </div>
    <div class="col-md-2" align="right">
      <b>Cost</b> (per acre)
    </div>
    <div class="col-sm" align="right">
      <b>Limit</b> (acres)
    </div>
    <div class="col-sm">
    </div>
  </div>
</div>

<div class="container">
  {% for crop in scenario.crops.all %}
  <div class="row {% cycle '' 'bg-light ' %}">
    <div class="col-sm">
      <a href="{% url "optimizer:crop_details" crop.id %}">
        {{ crop.data.name }}
      </a>
    </div>
    <div class="col-md-2" align="right">
      {{ crop.gross }}
    </div>
    <div class="col-md-2" align="right">
      {{ crop.prices }}
    </div>
    <div class="col-md-2" align="right">
      {% if crop.isYieldOverride %}
      *
      {% endif %}
      {{ crop.yields }}
    </div>
    <div class="col-md-2" align="right">
      {% if crop.isCostOverride %}
      *
      {% endif %}

      ${{ crop.net_cost|floatformat:"2"|intcomma }}
    </div>
    <div class="col-sm" align="right">
      {% if crop.isLimitOverride %}
      *
      {% endif %}
      {{ crop.show_limits }}
    </div>
    <div class="col-sm">
      <a href="{% url "optimizer:edit_crop" crop.id %}">
        <i class="fas fa-edit"></i>
      </a>
      <a data-toggle="modal" href="#removeCrop{{ forloop.counter }}">
        <i class="fas fa-minus-circle"></i>
      </a>
      <!-- Modal -->
      <div class="modal fade" id="removeCrop{{ forloop.counter }}" tabindex="-1" role="dialog" aria-labelledby="videoTitleLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="cropRemove">
                Remove Crop: {{ crop.data.name }}
              </h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <input type="button" value="Remove" class="btn btn-primary"
                     onclick="location.href='{% url 'optimizer:rmCropScenario' crop.id %}'">
              </input>
            </div>
          </div>
        </div>
      </div>
      <a href="{% url "optimizer:add_price" crop.id %}">
        <i class="fas fa-file-invoice-dollar"></i>
      </a>
    </div>
  </div>
  <div class="row">
    <div class="col-sm-3">
    </div>
    <div class="col">
      {% for price in crop.price_overrides.all %}
      <div class="row">
        <div class="col-6">
          {{ price.units }}
          {{ price.crop.data.unit }}{{ price.units|pluralize }} at
          ${{ price.price }} per {{ price.crop.data.unit }}
        </div>
        <div class="col">
        <a href="{% url "optimizer:edit_price" price.id %}">
          <i class="fas fa-edit"></i>
         </a>
        <a href="{% url "optimizer:remove_price" price.id %}">
          <i class="fas fa-minus-circle"></i>
         </a>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  {% empty %}
  <div class="row">
    <div class="col">
      No crops
    </div>
  </div>
  {% endfor %}
  <div class="row">
    <div class="col-sm">
    </div>
    <div class="col">
      (* indicates scenario override)
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <div class="col">
      <p>&nbsp;</p>
    </div>
  </div>
    <div class="row">
      <div class="col">
        <a href="{% url "optimizer:addCropScenario" scenario.id %}">
          <i class="fas fa-plus-circle"></i>
          Add crops
        </a>
    </div>
  </div>
</div>
<script>

// Loads Google Charts. When finished loading, drawCharts() is called.
google.charts.load('current', {'packages': ['corechart', 'bar']});
google.charts.setOnLoadCallback( chartSetup )

// Globals for storing stuff.
var scenarios = [], crops = [], charts = [], tables = [], options = []

options[ 'scnrio_tris' ] = {
  hAxis: {
    format: 'currency',
  },
  vAxis: {
    textPosition: 'none'
  },
  interpolateNulls: true,
  legend: {
    position: 'top'
  },
  height: 450,
  width: 1000,
  areaOpacity: 0.15,
  explorer: {
    zoomDelta: 1.05
  }
}

async function setupMultiTriangle( triples, options ) {

    for ( var triple of triples ) {
        triple[ 'points' ] = getCoordinates( triple[ 'values' ] )
    }

    // Sets options for the bounds of the chart, which are dependent
    // on the values stores in 'stats'.
    setTriChartOptions( triples, options )

    var dtable = await buildDataTable( triples )

    return dtable
}

// Builds a datatable for plotting the three-scenarios triangle chart. 
async function buildDataTable( triples, rows ) {

    var dtable = new google.visualization.DataTable();

    // Configures a 7-column table. The first column is the x-coordinate and
    // the each other 'number' column is the y-coordinate for that point.
    dtable.addColumn( 'number', 'value' )
    dtable.addColumn( 'number', 'Best worse case' )
    dtable.addColumn( {type:'string', role:'tooltip'} )
    dtable.addColumn( 'number', 'Best expected' )
    dtable.addColumn( {type:'string', role:'tooltip'} )
    dtable.addColumn( 'number', 'Best best case' )
    dtable.addColumn( {type:'string', role:'tooltip'} )

    var formatter = new Intl.NumberFormat( 'en-US', {
      style: 'currency',
      currency: 'USD',
    })

    // Initializes a 9x7 array with all cells nulled.
    var rows = Array.from( Array( 9 ), _ => Array( 7 ).fill( null ) );

    // For each triangle to be plotted, three points are added along with
    // annotations (Min, Peak, or Max) for the point.
    for ( var i in triples ) {
        var triple = triples[ i ][ 'points' ]
        var row = i * 3
        var col = i * 2

        rows[ row     ][ 0 ]       = triple[ 0 ][ 0 ]
        rows[ row     ][ col + 1 ] = triple[ 0 ][ 1 ]
        rows[ row     ][ col + 2 ] = 'Min: '  + formatter.format( triple[ 0 ][ 0 ] )

        rows[ row + 1 ][ 0 ]       = triple[ 1 ][ 0 ]
        rows[ row + 1 ][ col + 1 ] = triple[ 1 ][ 1 ]
        rows[ row + 1 ][ col + 2 ] = 'Peak: ' + formatter.format( triple[ 1 ][ 0 ] )

        rows[ row + 2 ][ 0 ]       = triple[ 2 ][ 0 ]
        rows[ row + 2 ][ col + 1 ] = triple[ 2 ][ 1 ]
        rows[ row + 2 ][ col + 2 ] = 'Max: '  + formatter.format( triple[ 2 ][ 0 ] )
    }

    // Sorts by first column (the x-coordinates of all triangle points).
    rows.sort( (a, b) => {
        if ( a[ 0 ] === b[ 0 ] ) {
            return 0
        } else { 
            return ( a[ 0 ] < b[ 0 ] ) ? -1 : 1
        }
    });

    rows.forEach( row => {
        dtable.addRow( row )
    })
 
    return dtable
}

  // Loads data, then populates and configures datables.
  async function chartSetup() {

    // Aliasing this to a shorter function.
    var ChartWrapper = google.visualization.ChartWrapper

    charts[ 'scenarios' ] = new ChartWrapper( { containerId: 'scenarioChart'  } )

    // Attempting to retrieve data from backend.
    regex = '[0-9]+(?=\/$)'
    var scenario_pk = location.pathname.match( regex )[ 0 ]
    try {
      [ scenarios, crops ] = await Promise.all( [ loadScenarioData( scenario_pk ), 
                                                  loadCropData( scenario_pk ) ]);
    } catch ( error ) {
      console.log( error )
    }

    // Configures the charts and builds its datatable.
    tables[ 'scenarios' ] = await setupMultiTriangle( [
      { values: scenarios[ 'min' ],  desc: 'Pessimistic' },
      { values: scenarios[ 'peak' ], desc: 'Expected' },
      { values: scenarios[ 'max' ],  desc: 'Optimistic' }
    ], options[ 'scnrio_tris' ]);

    // Renders the chart.
    drawChart( charts[ 'scenarios' ], 'AreaChart', 
      tables[ 'scenarios' ], options[ 'scnrio_tris' ]);

  }

</script>

{% endblock %}
